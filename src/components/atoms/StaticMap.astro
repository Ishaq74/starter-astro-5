---
import { Icon } from "astro-icon/components";
import Text from "@atoms/Text.astro";

// 1. LOGIQUE ENTIÈREMENT ENCAPSULÉE DANS L'ATOME
type SiteIdentity = {
  name?: string;
  geo?: { latitude: number; longitude: number };
  streetaddress?: string;
  postalCode?: string;
  addressLocality?: string;
  addressCountry?: string;
  [key: string]: any;
};

interface Props {
  siteidentity: SiteIdentity | null | undefined;
}

const { siteidentity } = Astro.props;
let interactiveMapUrl: string | undefined;
let mapAriaLabel: string | undefined;

if (siteidentity) {
  // Priorité 1: Coordonnées GEO
  if (siteidentity.geo && typeof siteidentity.geo === 'object' && 'latitude' in siteidentity.geo && 'longitude' in siteidentity.geo) {
    const lat = siteidentity.geo.latitude;
    const lon = siteidentity.geo.longitude;
    interactiveMapUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=15/${lat}/${lon}`;
  }
  // Priorité 2: Adresse complète
  else if (siteidentity.streetaddress) {
    const fullAddress = `${siteidentity.streetaddress}, ${siteidentity.postalCode ?? ''} ${siteidentity.addressLocality ?? ''}, ${siteidentity.addressCountry ?? ''}`;
    interactiveMapUrl = `https://www.openstreetmap.org/search?query=${encodeURIComponent(fullAddress.trim())}`;
  }

  // Préparation du label pour l'accessibilité
  if (interactiveMapUrl) {
    mapAriaLabel = `Voir ${siteidentity.name ?? 'notre localisation'} sur une carte interactive`;
  }
}
---

<!-- 2. L'ATOME DÉCIDE SEUL DE S'AFFICHER ET NE REND QUE LE LIEN <a> -->
{interactiveMapUrl && (
  <a 
    href={interactiveMapUrl} 
    target="_blank" 
    rel="noopener noreferrer" 
    aria-label={mapAriaLabel}
    class="static-map-placeholder"
  >
    <div class="map-icon-container">
      <Icon name="mdi:map-marker-radius-outline" />
    </div>
    <Text tag="span" class="map-text">
      Cliquer pour voir la carte
    </Text>
  </a>
)}

<style>
  .static-map-placeholder {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    background-color: var(--color-muted);
    color: var(--color-text);
    text-decoration: none;
    border-radius: inherit;
    transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
    text-align: center;
    padding: var(--space-10);
    box-sizing: border-box;
  }
  .static-map-placeholder:hover {
    background-color: var(--color-muted-dark);
    color: var(--color-text-dark);
  }
  .map-icon-container { font-size: var(--text-static-map-icon, 6rem); line-height: 1; margin-bottom: var(--space-5); }
  .map-text { font-weight: bold; }
</style>